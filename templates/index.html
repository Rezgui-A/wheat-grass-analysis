<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŒ¾ Wheatgrass Analyzer Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #28a745;
            --secondary-color: #17a2b8;
            --accent-color: #ffc107;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            margin-bottom: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .upload-area {
            border: 3px dashed #ced4da;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f8fff9;
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: #e8f5e9;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .result-image {
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            max-height: 400px;
            object-fit: contain;
        }
        
        .badge-success {
            background-color: var(--primary-color) !important;
        }
        
        .processing-spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .feature-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .tab-content {
            padding: 1.5rem;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-seedling me-2"></i>
                Wheatgrass Analyzer
            </a>
            <div class="navbar-text">
                <span id="sam-status" class="badge bg-secondary">
                    <i class="fas fa-brain me-1"></i>
                    <span id="sam-text">Checking SAM...</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container py-4">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold">
                        <i class="fas fa-chart-line me-2"></i>
                        Wheatgrass Analysis System
                    </h1>
                    <p class="lead mb-0">
                        Automatic beaker detection, plant height measurement, and health analysis
                        using advanced computer vision and machine learning.
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-inline-block bg-white text-dark rounded-pill px-3 py-2">
                        <i class="fas fa-clock me-2"></i>
                        <span id="current-time">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h4 class="mb-0">
                            <i class="fas fa-cloud-upload-alt me-2"></i>
                            Upload Wheatgrass Image
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Upload Area -->
                                <div id="uploadArea" class="upload-area">
                                    <i class="fas fa-file-image fa-4x mb-3 text-muted"></i>
                                    <h5>Drag & Drop Image Here</h5>
                                    <p class="text-muted mb-3">or click to browse</p>
                                    <input type="file" id="imageInput" class="d-none" accept="image/*">
                                    <button class="btn btn-primary btn-lg" onclick="document.getElementById('imageInput').click()">
                                        <i class="fas fa-folder-open me-2"></i>
                                        Browse Files
                                    </button>
                                    <p class="text-muted mt-3 mb-0">Supports JPG, PNG, BMP, TIFF (Max 16MB)</p>
                                </div>
                                
                            </div>
                            
                            <div class="col-md-6">
                                <!-- Instructions -->
                                <div class="alert alert-info">
                                    <h5>
                                        <i class="fas fa-info-circle me-2"></i>
                                        How to Get Best Results
                                    </h5>
                                    <ul class="mb-0">
                                        <li>Use clear, well-lit images</li>
                                        <li>Ensure beaker is visible and centered</li>
                                        <li>Soil should be in bottom 10-20% of beaker</li>
                                        <li>Avoid reflections and glare</li>
                                        <li>Include entire plant canopy</li>
                                    </ul>
                                </div>
                                
                                <!-- Features -->
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <div class="text-center p-3">
                                            <div class="feature-icon">
                                                <i class="fas fa-ruler-combined"></i>
                                            </div>
                                            <h6>Height Measurement</h6>
                                            <small class="text-muted">Precision to 0.001 cm</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-3">
                                            <div class="feature-icon">
                                                <i class="fas fa-heartbeat"></i>
                                            </div>
                                            <h6>Health Analysis</h6>
                                            <small class="text-muted">Color-based health scoring</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Processing Status -->
                        <div id="processingAlert" class="alert alert-warning mt-3 d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border processing-spinner text-primary me-3" role="status"></div>
                                <div>
                                    <h6 class="mb-1" id="processingTitle">Processing Image...</h6>
                                    <p class="mb-0 text-muted" id="processingText">
                                        Analyzing beaker, detecting plants, calculating heights...
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section (Initially Hidden) -->
        <div id="resultsSection" class="d-none">
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h4 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Analysis Results
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row" id="statsContainer">
                                <!-- Stats populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Images -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-white">
                            <ul class="nav nav-tabs card-header-tabs" id="imageTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                                        <i class="fas fa-eye me-2"></i>Overview
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="mask-tab" data-bs-toggle="tab" data-bs-target="#mask" type="button">
                                        <i class="fas fa-leaf me-2"></i>Plant Mask
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button">
                                        <i class="fas fa-heart me-2"></i>Plant Health
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button">
                                        <i class="fas fa-chart-line me-2"></i>Height Profile
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="dist-tab" data-bs-toggle="tab" data-bs-target="#dist" type="button">
                                        <i class="fas fa-chart-bar me-2"></i>Distribution
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <img id="overviewImage" class="img-fluid result-image w-100" alt="Detection Overview">
                            </div>
                            <div class="tab-pane fade" id="mask" role="tabpanel">
                                <img id="maskImage" class="img-fluid result-image w-100" alt="Plant Mask">
                            </div>
                            <div class="tab-pane fade" id="health" role="tabpanel">
                                <img id="healthImage" class="img-fluid result-image w-100" alt="Plant Health">
                            </div>
                            <div class="tab-pane fade" id="profile" role="tabpanel">
                                <img id="profileImage" class="img-fluid result-image w-100" alt="Height Profile">
                            </div>
                            <div class="tab-pane fade" id="dist" role="tabpanel">
                                <img id="distImage" class="img-fluid result-image w-100" alt="Height Distribution">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results & Export -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list-alt me-2"></i>
                                Detailed Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="detailedResults">
                                <!-- Detailed results populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-download me-2"></i>
                                Export Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="downloadJSON()">
                                    <i class="fas fa-file-code me-2"></i>
                                    Download JSON Data
                                </button>
                                <button class="btn btn-outline-success" onclick="downloadCSV()">
                                    <i class="fas fa-file-csv me-2"></i>
                                    Download CSV Report
                                </button>
                                <button class="btn btn-outline-info" onclick="downloadImages()">
                                    <i class="fas fa-images me-2"></i>
                                    Download All Images
                                </button>
                                <button class="btn btn-outline-danger" onclick="startNewAnalysis()">
                                    <i class="fas fa-redo me-2"></i>
                                    Start New Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-code me-1"></i>
                    Wheatgrass Analyzer Web App v1.0
                    <span class="mx-2">â€¢</span>
                    <i class="fas fa-server me-1"></i>
                    <span id="server-status">Server: Checking...</span>
                </p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
          const IS_VERCEL = window.location.hostname.includes('vercel.app');
    const API_PREFIX = IS_VERCEL ? '/api' : '';
    
    // Update ALL your fetch calls like this:
    // OLD: fetch('/api/analyze', ...)
    // NEW: fetch(API_PREFIX + '/api/analyze', ...)
    
    // Update checkServerStatus function:
    function checkServerStatus() {
        fetch(API_PREFIX + '/api/status')  // <-- ADD API_PREFIX
            .then(res => res.json())
            .then(data => {
                document.getElementById('server-status').textContent = 
                    `Server: ${data.status === 'running' ? 'Online' : 'Offline'}`;
                
                const samEl = document.getElementById('sam-text');
                const badgeEl = document.getElementById('sam-status');
                
                if (data.sam_loaded) {
                    samEl.textContent = 'SAM: Loaded âœ“';
                    badgeEl.className = 'badge badge-success';
                } else if (data.sam_available) {
                    samEl.textContent = 'SAM: Available';
                    badgeEl.className = 'badge bg-warning';
                } else {
                    samEl.textContent = 'SAM: Not Available';
                    badgeEl.className = 'badge bg-secondary';
                }
            })
            .catch(err => {
                document.getElementById('server-status').textContent = 'Server: Offline';
            });
    }
    
    // Update analyzeSingle function:
    function analyzeSingle(file) {
        if (!file.type.match('image.*')) {
            alert('Please select an image file');
            return;
        }
        
        showProcessing('Processing Image...', 'Analyzing wheatgrass image...');
        
        const formData = new FormData();
        formData.append('image', file);
        
        fetch(API_PREFIX + '/api/analyze', {  // <-- ADD API_PREFIX
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            currentResults = data;
            
            if (data.success) {
                displayResults(data); 
            } else {
                hideProcessing();
                alert(`Analysis failed: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(err => {
            hideProcessing();
            alert(`Error: ${err.message}`);
        });
    }
    
    // Update analyzeBatch function similarly:
    function analyzeBatch() {
        const files = document.getElementById('batchInput').files;
        
        if (files.length === 0) {
            alert('Please select images first');
            return;
        }
        
        showProcessing(`Processing ${files.length} Images...`, 'Batch analysis in progress...');
        
        const formData = new FormData();
        for (let file of files) {
            formData.append('images[]', file);
        }
        
        fetch(API_PREFIX + '/api/batch', {  // <-- ADD API_PREFIX
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            hideProcessing();
            
            if (data.success) {
                if (data.results.length > 0) {
                    currentResults = data.results[0];
                    displayResults(data.results[0]);
                }
                alert(`Batch analysis complete! Processed ${data.total} images.`);
            } else {
                alert(`Batch analysis failed: ${data.error}`);
            }
        })
        .catch(err => {
            hideProcessing();
            alert(`Error: ${err.message}`);
        });
    }
        let currentResults = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            checkServerStatus();
            
            // Setup drag and drop
            setupDragAndDrop();
            
            // File input change handler
            document.getElementById('imageInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    analyzeSingle(e.target.files[0]);
                }
            });
            
            // Batch input change handler
            document.getElementById('batchInput').addEventListener('change', function(e) {
                // Preview batch files
                if (e.target.files.length > 0) {
                    console.log(`Selected ${e.target.files.length} files for batch processing`);
                }
            });
        });
        
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('en-US', {hour12: false});
        }
        
        function checkServerStatus() {
            fetch(API_PREFIX + '/api/status')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('server-status').textContent = 
                        `Server: ${data.status === 'running' ? 'Online' : 'Offline'}`;
                    
                    const samEl = document.getElementById('sam-text');
                    const badgeEl = document.getElementById('sam-status');
                    
                    if (data.sam_loaded) {
                        samEl.textContent = 'SAM: Loaded âœ“';
                        badgeEl.className = 'badge badge-success';
                    } else if (data.sam_available) {
                        samEl.textContent = 'SAM: Available';
                        badgeEl.className = 'badge bg-warning';
                    } else {
                        samEl.textContent = 'SAM: Not Available';
                        badgeEl.className = 'badge bg-secondary';
                    }
                })
                .catch(err => {
                    document.getElementById('server-status').textContent = 'Server: Offline';
                });
        }
        
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    analyzeSingle(files[0]);
                }
            }
        }
        
        function analyzeSingle(file) {
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }
            
            showProcessing('Processing Image...', 'Analyzing wheatgrass image...');
            
            const formData = new FormData();
            formData.append('image', file);
            
            fetch(API_PREFIX + '/api/analyze', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                currentResults = data;
                
                if (data.success) {
                    displayResults(data);
                } else {
                    hideProcessing();
                    alert(`Analysis failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(err => {
                hideProcessing();
                alert(`Error: ${err.message}`);
            });
        }
        
        function analyzeBatch() {
            const files = document.getElementById('batchInput').files;
            
            if (files.length === 0) {
                alert('Please select images first');
                return;
            }
            
            if (files.length > 10) {
                if (!confirm(`You selected ${files.length} images. This may take a while. Continue?`)) {
                    return;
                }
            }
            
            showProcessing(`Processing ${files.length} Images...`, 'Batch analysis in progress...');
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('images[]', file);
            }
            
            fetch(API_PREFIX + '/api/batch', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                hideProcessing();
                
                if (data.success) {
                    // For simplicity, just show the first result
                    if (data.results.length > 0) {
                        currentResults = data.results[0];
                        displayResults(data.results[0]);
                    }
                    
                    alert(`Batch analysis complete! Processed ${data.total} images.`);
                } else {
                    alert(`Batch analysis failed: ${data.error}`);
                }
            })
            .catch(err => {
                hideProcessing();
                alert(`Error: ${err.message}`);
            });
        }
        
        function displayResults(results) {
            hideProcessing();
            
            // Show results section
            document.getElementById('resultsSection').classList.remove('d-none');
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({behavior: 'smooth'});
            
            // Update statistics
            const stats = results.analysis;
            const statsHtml = `
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.avg_height_cm}</div>
                        <div class="stat-label">Avg Height (cm)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.max_height_cm}</div>
                        <div class="stat-label">Max Height (cm)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.min_height_cm}</div>
                        <div class="stat-label">Min Height (cm)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.health_score.toFixed(2)}</div>
                        <div class="stat-label">Health Score</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.std_height_cm.toFixed(2)}</div>
                        <div class="stat-label">Std Dev (cm)</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.plant_pixels.toLocaleString()}</div>
                        <div class="stat-label">Plant Pixels</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.canopy_points}</div>
                        <div class="stat-label">Canopy Points</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-value">${stats.processing_time}s</div>
                        <div class="stat-label">Processing Time</div>
                    </div>
                </div>
            `;
            document.getElementById('statsContainer').innerHTML = statsHtml;
            
            // Update images
            if (results.images.overview) {
                document.getElementById('overviewImage').src = `data:image/png;base64,${results.images.overview}`;
            }
            if (results.images.plant_mask) {
                document.getElementById('maskImage').src = `data:image/png;base64,${results.images.plant_mask}`;
            }
            if (results.images.plant_health) {
                document.getElementById('healthImage').src = `data:image/png;base64,${results.images.plant_health}`;
            }
            if (results.images.height_profile) {
                document.getElementById('profileImage').src = `data:image/png;base64,${results.images.height_profile}`;
            }
            if (results.images.height_dist) {
                document.getElementById('distImage').src = `data:image/png;base64,${results.images.height_dist}`;
            }
            
            // Update detailed results
            const detailedHtml = `
                <div class="row">
                    <div class="col-6">
                        <p><strong>Image:</strong> ${results.filename}</p>
                        <p><strong>Dimensions:</strong> ${stats.image_shape[1]}Ã—${stats.image_shape[0]} px</p>
                        <p><strong>Beaker Region:</strong> ${stats.beaker_region.x_start}-${stats.beaker_region.x_end}Ã—${stats.beaker_region.y_start}-${stats.beaker_region.y_end}</p>
                        <p><strong>Soil Line:</strong> y=${stats.soil_line_y} px</p>
                    </div>
                    <div class="col-6">
                        <p><strong>Pixel Ratio:</strong> ${stats.pixel_ratio.toFixed(6)} cm/px</p>
                        <p><strong>Soil Height:</strong> ${stats.soil_height_cm} cm (${stats.soil_height_inch} in)</p>
                        <p><strong>Greenness Score:</strong> ${stats.greenness_score.toFixed(3)}</p>
                        <p><strong>Colorfulness:</strong> ${stats.colorfulness_score.toFixed(3)}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-light">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Analysis completed at ${new Date(results.timestamp).toLocaleString()}
                                ${stats.sam_loaded ? ' â€¢ SAM was used for detection' : ' â€¢ Traditional CV methods were used'}
                            </small>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('detailedResults').innerHTML = detailedHtml;
        }
        
        function showProcessing(title, text) {
            document.getElementById('processingTitle').textContent = title;
            document.getElementById('processingText').textContent = text;
            document.getElementById('processingAlert').classList.remove('d-none');
        }
        
        function hideProcessing() {
            document.getElementById('processingAlert').classList.add('d-none');
        }
        
        function downloadJSON() {
            if (!currentResults) return;
            
            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = `wheatgrass_analysis_${currentResults.filename.replace(/\.[^/.]+$/, "")}_${Date.now()}.json`;
            link.click();
        }
        
        function downloadCSV() {
            if (!currentResults) return;
            
            const stats = currentResults.analysis;
            const csvData = [
                ['Metric', 'Value', 'Unit'],
                ['Filename', currentResults.filename, ''],
                ['Timestamp', currentResults.timestamp, ''],
                ['Average Height', stats.avg_height_cm, 'cm'],
                ['Average Height', stats.avg_height_inch, 'in'],
                ['Maximum Height', stats.max_height_cm, 'cm'],
                ['Minimum Height', stats.min_height_cm, 'cm'],
                ['Median Height', stats.median_height_cm, 'cm'],
                ['Std Deviation', stats.std_height_cm, 'cm'],
                ['Health Score', stats.health_score, ''],
                ['Greenness Score', stats.greenness_score, ''],
                ['Colorfulness Score', stats.colorfulness_score, ''],
                ['Plant Pixels', stats.plant_pixels, ''],
                ['Soil Height', stats.soil_height_cm, 'cm'],
                ['Pixel Ratio', stats.pixel_ratio, 'cm/px'],
                ['Canopy Points', stats.canopy_points, ''],
                ['Processing Time', stats.processing_time, 's'],
                ['Image Width', stats.image_shape ? stats.image_shape[1] : '', 'px'],
                ['Image Height', stats.image_shape ? stats.image_shape[0] : '', 'px'],
                ['SAM Used', stats.sam_loaded ? 'Yes' : 'No', '']
            ];
            
            const csv = Papa.unparse(csvData);
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = `wheatgrass_report_${currentResults.filename.replace(/\.[^/.]+$/, "")}_${Date.now()}.csv`;
            link.click();
        }
        
        function downloadImages() {
            if (!currentResults || !currentResults.images) return;
            
            // Create a ZIP of all images
            alert('Image download would create a ZIP file with all visualization images.');
            // Implementation would require a ZIP library like JSZip
        }
        
        function startNewAnalysis() {
            currentResults = null;
            document.getElementById('resultsSection').classList.add('d-none');
            document.getElementById('imageInput').value = '';
            document.getElementById('batchInput').value = '';
            
            // Scroll to top
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    </script>
</body>
</html>